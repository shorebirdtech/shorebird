# Руководство по развертыванию Self-Hosted Shorebird

Это пошаговое руководство поможет вам развернуть и настроить собственный сервер обновлений Shorebird на локальной машине для разработки и тестирования с Android-эмулятором или реальным устройством в локальной сети.

## 1. Подготовка окружения

Вам понадобятся:
- **Docker Desktop** (установлен и запущен).
- **Shorebird CLI** (установлен).
- **Flutter SDK**.
- **Android Emulator** или реальное устройство.

## 2. Настройка IP-адреса

Для того чтобы и эмулятор (Android), и ваш компьютер, и Docker-контейнеры могли общаться друг с другом, необходимо использовать ваш **локальный IP-адрес** (Wi-Fi или LAN), а не `localhost` или `10.0.2.2`.

1.  Откройте терминал и узнайте свой IP:
    *   **Windows**: `ipconfig` (ищите IPv4 адрес адаптера Беспроводная сеть или Ethernet, например `192.168.1.139`).
    *   **macOS/Linux**: `ifconfig` или `ip a`.

2.  Запомните этот IP. Далее в инструкции будем называть его `ВАШ_IP`.

## 3. Настройка Сервера

1.  Перейдите в папку сервера:
    ```bash
    cd packages/self_hosted_server
    ```

2.  Откройте файл `docker-compose.yml`.
3.  Отредактируйте переменные окружения, подставив `ВАШ_IP`:

    ```yaml
    services:
      api:
        environment:
          # ... другие переменные
          - HOST=0.0.0.0          # Важно! Слушаем все интерфейсы
          - S3_ENDPOINT=minio     # Внутреннее имя контейнера (не меняйте)
          - S3_PUBLIC_ENDPOINT=ВАШ_IP  # <-- СЮДА ВСТАВИТЬ IP (например 192.168.1.139)
          - S3_PORT=9000

      minio:
        environment:
          - MINIO_SERVER_URL=http://ВАШ_IP:9000 # <-- СЮДА ВСТАВИТЬ IP
    ```

### Запуск сервера

1.  Очистите старые данные (если были эксперименты):
    ```bash
    docker-compose down -v
    ```
    *(Флаг `-v` удалит базу данных и файлы в MinIO, чтобы начать с чистого листа)*.

2.  Запустите сервер:
    ```bash
    docker-compose up -d --build
    ```

3.  Проверьте, что контейнеры работают:
    ```bash
    docker ps
    ```
    Должны быть запущены `self_hosted_server-api` (порт 8080) и `self_hosted_server-minio` (порты 9000, 9001).

## 4. Настройка Клиента (Ваше Приложение)

Перейдите в папку вашего Flutter-проекта (например `examples/test`).

1.  **Создайте конфигурацию**:
    Если у вас уже есть файл `shorebird.yaml`, **удалите его**. Мы создадим новый, который зарегистрируется на вашем чистом сервере.

2.  **Инициализация**:
    Выполните команду init, указав параметры:
    ```bash
    shorebird init
    ```
    
3.  **Редактирование `shorebird.yaml`**:
    Сразу после создания откройте появившийся `shorebird.yaml` и измените (или добавьте) параметр `base_url`:

    ```yaml
    app_id: ... (автоматически сгенерированный ID) ...
    
    # Укажите адрес вашего локального сервера
    base_url: http://ВАШ_IP:8080
    ```

## 5. Создание Релиза

Теперь нужно собрать приложение, в которое "запечется" этот `shorebird.yaml` с вашим IP.

1.  Создайте релиз:
    ```bash
    shorebird release android
    ```
    *Согласитесь с созданием релиза, если спросит.*

2.  Установите полученный APK на устройство/эмулятор:
    ```bash
    # Сначала удалите старую версию во избежание конфликтов подписей
    adb uninstall com.example.test 
    
    # Установите новую (путь может отличаться)
    adb install build/app/outputs/flutter-apk/app-release.apk
    ```

3.  **Запустите приложение** на телефоне. Это будет "Версия 1.0.0" (условно).

## 6. Выпуск Патча (Обновление по воздуху)

1.  Внесите видимые изменения в код Dart (например, поменяйте цвет фона или текст на кнопке).

2.  Выпустите патч:
    ```bash
    shorebird patch --platforms=android
    ```
    CLI скачает артефакты с вашего сервера, соберет патч и загрузит его обратно на ваш сервер.

## 7. Проверка Обновления

1.  **Закройте приложение** на телефоне (выгрузите из памяти/свайпните).
2.  **Откройте приложение (1-й запуск)**.
    *   В этот момент приложение в фоне спросит сервер `http://ВАШ_IP:8080/api/v1/patches/check`.
    *   Сервер ответит ссылкой на скачивание.
    *   Приложение скачает патч. Пользователь пока видит старую версию.
3.  **Закройте приложение** снова.
4.  **Откройте приложение (2-й запуск)**.
    *   Патч применится. Вы должны увидеть ваши изменения.

## Решение проблем

### "Artifact not found" или "SignatureDoesNotMatch"
Это значит, что сервер или клиент путаются в IP-адресах.
*   Убедитесь, что в `docker-compose.yml` в `S3_PUBLIC_ENDPOINT` стоит именно IP компьютера, а не `localhost`.
*   Убедитесь, что сервер Proxy (`api`) запущен и логирует запросы к `artifcats/...`. Наш сервер настроен работать как прокси, чтобы скрыть сложность MinIO.

### Приложение не обновляется
Проверьте логи Android через `adb logcat`:
```bash
adb logcat | grep flutter
```
Ищите сообщения от `shorebird`. Если видите "Connection refused", значит, телефон не видит компьютер по указанному IP (проверьте фаервол или находятся ли они в одной сети).

### Как сбросить всё и начать заново?
Если запутались в версиях и релизах:
1. `docker-compose down -v` (на сервере).
2. `rm shorebird.yaml` (в проекте).
3. `shorebird init`.
4. Впишите `base_url` в новый `shorebird.yaml`.
5. Повысьте версию в `pubspec.yaml` (например `1.0.0+1` -> `1.0.0+2`).
6. `shorebird release android`.
